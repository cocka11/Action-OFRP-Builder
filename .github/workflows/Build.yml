name: OrangeFox Garnet Build

on:
workflow_dispatch:

jobs:
build:
runs-on: ubuntu-22.04
timeout-minutes: 900

steps:

- name: Swap (avoid OOM)
  uses: pierotofy/set-swap-space@master
  with:
    swap-size-gb: 20

- name: Install packages
  run: |
    sudo apt update
    sudo apt install -y \
      git-core repo bc bison build-essential curl flex g++-multilib \
      gcc-multilib gnupg gperf imagemagick lib32ncurses5-dev \
      lib32readline-dev lib32z1-dev libelf-dev liblz4-tool \
      libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev \
      libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools \
      xsltproc zip zlib1g-dev python3 ccache

- name: Configure git
  run: |
    git config --global user.name "github-actions"
    git config --global user.email "actions@github.com"

- name: Init OrangeFox source
  run: |
    mkdir fox && cd fox
    repo init -u https://gitlab.com/OrangeFox/sync.git -b fox_12.1
    repo sync -j$(nproc --all)

# IMPORTANT â€” replace official device with yours (latest)
- name: Replace device tree (garnet)
  run: |
    cd fox
    rm -rf device/garnet
    git clone https://gitlab.com/OrangeFox/device/garnet.git device/garnet

- name: Enable ccache
  run: |
    echo "export USE_CCACHE=1" >> ~/.bashrc
    echo "export CCACHE_EXEC=/usr/bin/ccache" >> ~/.bashrc
    ccache -M 50G

- name: Build OrangeFox
  run: |
    cd fox
    source build/envsetup.sh
    lunch fox_garnet-eng
    mka recoveryimage -j$(nproc --all)

- name: Upload recovery
  uses: actions/upload-artifact@v4
  with:
    name: OrangeFox-garnet
    path: fox/out/target/product/garnet/recovery.img
