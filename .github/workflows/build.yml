name: Build OrangeFox (Garnet)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 900

    steps:
      # 1️⃣ Swap për OOM
      - name: Setup swap
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 20

      # 2️⃣ Instalimi i dependencies
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git-core repo bc bison build-essential curl flex g++-multilib \
            gcc-multilib gnupg gperf lib32ncurses5-dev lib32readline-dev lib32z1-dev libssl-dev \
            python3 ccache unzip zip rsync squashfs-tools lzop schedtool imagemagick libxml2-utils

      # 3️⃣ Git identity
      - name: Configure git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

      # 4️⃣ Init source (CI-friendly)
      - name: Initialize OrangeFox source
        run: |
          rm -rf fox
          mkdir fox
          cd fox
          # Public mirror, Android 13
          repo init -u https://github.com/OrangeFoxRecovery/manifest.git -b android-13.0 --depth=1
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
          # Device tree public mirror
          git clone https://github.com/OrangeFoxRecovery/device_garnet.git device/garnet

      # 5️⃣ Enable ccache
      - name: Enable ccache
        run: |
          echo "export USE_CCACHE=1" >> $HOME/.bashrc
          echo "export CCACHE_EXEC=/usr/bin/ccache" >> $HOME/.bashrc
          ccache -M 50G

      # 6️⃣ Build recovery.img
      - name: Build OrangeFox Recovery
        run: |
          cd fox
          source build/envsetup.sh
          lunch fox_garnet-eng
          mka recoveryimage -j$(nproc --all)

      # 7️⃣ Upload artifact
      - name: Upload recovery.img
        uses: actions/upload-artifact@v4
        with:
          name: OrangeFox-Garnet
          path: fox/out/target/product/garnet/recovery.img
